<!DOCTYPE html>
<html>
<head>
    <title>Pipit</title>
    <script>
        function storeCursorPosition() {
            var input = document.getElementById("guess");
            localStorage.setItem("cursorPosition", input.selectionStart);
        }

        function restoreCursorPosition() {
            var input = document.getElementById("guess");
            var cursorPosition = localStorage.getItem("cursorPosition");
            if (cursorPosition) {
                input.selectionStart = cursorPosition;
                input.selectionEnd = cursorPosition;
            }
        }
        function resetForm() {
            document.getElementById("guess").value = "...";
        }
        window.onload = restoreCursorPosition;
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1> Pipit
    <img src="{{ url_for('static', filename='pipit_2.jpg') }}" alt="My Image" width="45" height="45" style="border-radius: 50%; float:left;">
    </h1>
    <form action="/" method="post">
        <input type="text" id="guess" name="guess" placeholder="Your guess..." autofocus onblur="storeCursorPosition()" spellcheck="false" autocomplete="off" autocorrect=""off>
    </form>
    <h1> </h1>
    <break></break>
    <div class="container"></div>
        <table>
            <tbody>
                <th>
                    Guess
                </th>
                <th>
                    Paths
                </th>
            {% for word in game.full_stack %}
            {% set rowloop = loop %}
                <tr>
                    {% for key in word.keys() %}
                        {% if key == 'paths' and not rowloop.last and not rowloop.first %}
                            {% if word[key] != '??' and game.full_stack[rowloop.index0 + 1]['paths'] == '??' %}
                                <td>
                                    <div class="flip" id="counter"> {{ word[key] }}</div>
                                <script>
                                    var counter_start = Number("{{ game.full_stack[rowloop.index0 - 1]['paths'] }}")
                                    var counter_end = Number("{{ word[key] }}")
                                    if (counter_end >= counter_start) {
                                        // up
                                        direction = 1;
                                    }
                                    else {
                                        // down
                                        direction = -1;
                                    }
                                    var counter_diff = Math.abs(counter_end - counter_start)
                                    var interval = Math.max(Math.ceil(Math.sqrt(counter_diff)/10), 1);
                                    let counter = counter_start;
                                    const intervalId = setInterval(() => {
                                        counter+=interval*direction;
                                        document.getElementById("counter").textContent = counter;
                                        if (counter <= counter_end && direction == -1) {
                                        clearInterval(intervalId);
                                        document.getElementById("counter").textContent = counter = counter_end;
                                        }
                                        else if (counter >= counter_end && direction == 1) {
                                        clearInterval(intervalId);
                                        document.getElementById("counter").textContent = counter = counter_end;
                                        }
                                    }, 1); // Adjust the interval time as needed
                                </script>
                                </td>
                            {% else %}
                                <td class ="{{ key }}{% if word['paths']==0 %} lost{% endif %}">{{ word[key] }}</td>
                            {% endif %}
                        {% else %}
                            <td class ="{{ key }}{% if word['paths']==0 %} lost{% endif %}">{{ word[key] }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <script>
            const flipElement = document.querySelector('.flip');
            const initialValue = parseInt(document.querySelector('.starting_num').textContent);
            flipElement.style.setProperty('--num', initialValue);
        </script>
    </div>
    {% if game.message != '' %}
    <p class="{% if not game.valid_guess %}error{% endif %}">{{ game.message }}</p>
    {% endif %}
    {% if game.score %}
    <p>Score: {{ game.score }}</p>
    {% endif %}
</body>

</html>